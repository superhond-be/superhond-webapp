import express from "express";
import { v4 as uuid } from "uuid";
import db from "../db.js";

const router = express.Router();

// Zorg dat de tabel bestaat
db.exec(`
  CREATE TABLE IF NOT EXISTS sessions (
    id TEXT PRIMARY KEY,
    class_id INTEGER,
    date TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT,
    location TEXT,
    FOREIGN KEY (class_id) REFERENCES classes(id)
  )
`);

// 📋 Alle sessies ophalen (met klasnaam erbij)
router.get("/", (_req, res) => {
  const rows = db.prepare(`
    SELECT s.*, c.title AS class_name
    FROM sessions s
    LEFT JOIN classes c ON c.id = s.class_id
    ORDER BY s.date, s.start_time
  `).all();
  res.json(rows);
});

// ➕ Nieuwe sessie toevoegen
router.post("/", (req, res) => {
  const id = uuid();
  const { class_id = null, date, start_time, end_time = "", location = "" } = req.body;

  if (!date || !start_time) {
    return res.status(400).json({ error: "date en start_time zijn verplicht" });
  }

  db.prepare(`
    INSERT INTO sessions (id, class_id, date, start_time, end_time, location)
    VALUES (?,?,?,?,?,?)
  `).run(id, class_id, date, start_time, end_time, location);

  res.status(201).json({ success: true, id });
});

// ❌ Sessie verwijderen
router.delete("/:id", (req, res) => {
  const info = db.prepare("DELETE FROM sessions WHERE id = ?").run(req.params.id);
  if (info.changes === 0) return res.status(404).json({ error: "Les niet gevonden" });
  res.json({ success: true });
});

export default router;
