<!-- public/settings.html -->

<link rel="stylesheet" href="/styles.css">
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Instellingen • Superhond</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; }
    header { display:flex; align-items:center; gap:12px; padding:16px; border-bottom:1px solid #eee; }
    header img { height:36px; width:36px; object-fit:cover; border-radius:6px; }
    main { max-width:1000px; margin:24px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:16px; background:#fff; }
    .card h3 { margin:0 0 12px; }
    label { display:block; font-size:14px; color:#374151; margin:8px 0 4px; }
    input[type="text"], input[type="number"], input[type="url"], input[type="email"], select {
      width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;
    }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .actions { display:flex; gap:12px; justify-content:flex-end; margin-top:24px; }
    button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; }
    .primary { background:#1a73e8; color:#fff; }
    .ghost { background:#f3f4f6; }
    .badge { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .nav { padding:8px 16px; border-bottom:1px solid #eee; }
    .nav a { margin-right:12px; text-decoration:none; color:#374151; }
    .nav a.active { color:#1a73e8; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <img id="logo" src="/logo.png" alt="logo" onerror="this.style.display='none'">
    <div>
      <div style="font-weight:700">Superhond • Instellingen</div>
      <div class="badge">Admin</div>
    </div>
  </header>

  <div class="nav">
    <a href="/index.html">Dashboard</a>
    <a href="/classes.html">Klassen</a>
    <a href="/sessions.html">Sessieplanning</a>
    <a href="/bookings.html">Boekingen</a>
    <a href="/settings.html" class="active">Instellingen</a>
  </div>

  <main>
    <div class="grid">
      <!-- Organisatie & branding -->
      <section class="card">
        <h3>Organisatie & branding</h3>
        <label>Naam organisatie</label>
        <input id="org_naam" type="text" placeholder="Superhond">
        <div class="row">
          <div>
            <label>Logo URL</label>
            <input id="org_logoUrl" type="url" placeholder="https://.../logo.png">
          </div>
          <div>
            <label>Primair kleurnummer</label>
            <input id="org_kleur" type="text" placeholder="#1a73e8">
          </div>
        </div>
      </section>

      <!-- Leslogica & credits -->
      <section class="card">
        <h3>Leslogica & credits</h3>
        <div class="row">
          <div>
            <label>Max. actieve reservaties per klas</label>
            <input id="logic_maxRes" type="number" min="0" step="1">
          </div>
          <div>
            <label>Annulatiegrens (uren vooraf)</label>
            <input id="logic_cancelHrs" type="number" min="0" step="1">
          </div>
        </div>
        <label>Creditverbruik</label>
        <select id="logic_credit">
          <option value="ATTEND">Bij aanwezigheid (aanbevolen)</option>
          <option value="RESERVE">Bij reservatie</option>
        </select>
      </section>

      <!-- Capaciteit & locaties -->
      <section class="card">
        <h3>Locaties & capaciteiten</h3>
        <div id="locaties"></div>
        <div class="row">
          <div><input id="loc_naam" type="text" placeholder="Naam locatie (bv. Dessel - Tabloo)"></div>
          <div><input id="loc_cap" type="number" min="1" placeholder="Max. deelnemers (default)"></div>
        </div>
        <div class="actions">
          <button class="ghost" onclick="addLocatie()">Locatie toevoegen</button>
        </div>
      </section>

      <!-- Agenda & herinneringen -->
      <section class="card">
        <h3>Agenda & herinneringen</h3>
        <label><input id="ics_on" type="checkbox"> ICS-export inschakelen</label>
        <label><input id="ics_only_self" type="checkbox"> In persoonlijke ICS alleen eigen boekingen</label>
        <label>Reminder (uren vooraf)</label>
        <input id="reminder_hrs" type="number" min="0" step="1">
      </section>

      <!-- Communicatie -->
      <section class="card">
        <h3>Communicatie</h3>
        <label>Afzender naam</label>
        <input id="mail_name" type="text" placeholder="Superhond Team">
        <label>Afzender e-mail</label>
        <input id="mail_addr" type="email" placeholder="info@superhond.be">
        <label><input id="wa_groups" type="checkbox"> Automatisch WhatsApp-groepen beheren</label>
      </section>

      <!-- Security & Rollen -->
      <section class="card">
        <h3>Privacy & rollen</h3>
        <label>Toegelaten rollen</label>
        <input id="roles" type="text" placeholder="ADMIN, COACH">
        <small>Opmerking: toewijzing per gebruiker volgt later.</small>
      </section>
    </div>

    <div class="actions">
      <button class="ghost" onclick="loadSettings()">Herladen</button>
      <button class="primary" onclick="saveSettings()">Opslaan</button>
    </div>
  </main>

  <script>
    let CURRENT = null;

    async function api(method, url, body) {
      const res = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function renderLocaties(list) {
      const wrap = document.getElementById("locaties");
      wrap.innerHTML = "";
      (list || []).forEach((loc, idx) => {
        const row = document.createElement("div");
        row.className = "row";
        row.style.marginBottom = "8px";
        row.innerHTML = `
          <div><input data-idx="${idx}" data-key="naam" type="text" value="${loc.naam ?? ""}"></div>
          <div><input data-idx="${idx}" data-key="maxDeelnemersDefault" type="number" min="1" value="${loc.maxDeelnemersDefault ?? 10}"></div>
          <div style="flex:0">
            <button class="ghost" onclick="removeLocatie(${idx})">✕</button>
          </div>`;
        wrap.appendChild(row);
      });
      wrap.querySelectorAll("input").forEach(el => {
        el.addEventListener("input", e => {
          const i = parseInt(e.target.dataset.idx, 10);
          const k = e.target.dataset.key;
          CURRENT.locaties[i][k] = (k === "maxDeelnemersDefault") ? parseInt(e.target.value || "0", 10) : e.target.value;
        });
      });
    }

    function addLocatie() {
      CURRENT.locaties = CURRENT.locaties || [];
      CURRENT.locaties.push({ id: Date.now(), naam: "", maxDeelnemersDefault: 10 });
      renderLocaties(CURRENT.locaties);
    }
    function removeLocatie(i) {
      CURRENT.locaties.splice(i, 1);
      renderLocaties(CURRENT.locaties);
    }

    async function loadSettings() {
      CURRENT = await api("GET", "/api/settings");
      // vul velden
      document.getElementById("org_naam").value = CURRENT.org?.naam ?? "";
      document.getElementById("org_logoUrl").value = CURRENT.org?.logoUrl ?? "";
      document.getElementById("org_kleur").value = CURRENT.org?.primaireKleur ?? "#1a73e8";

      document.getElementById("logic_maxRes").value = CURRENT.logic?.maxActieveReservatiesPerKlas ?? 2;
      document.getElementById("logic_cancelHrs").value = CURRENT.logic?.annulatieUurgrens ?? 12;
      document.getElementById("logic_credit").value = CURRENT.logic?.creditVerbruik ?? "ATTEND";

      renderLocaties(CURRENT.locaties || []);

      document.getElementById("ics_on").checked = !!CURRENT.agenda?.icsExportAan;
      document.getElementById("ics_only_self").checked = !!CURRENT.agenda?.persoonlijkeIcsAlleenEigenBoekingen;
      document.getElementById("reminder_hrs").value = CURRENT.agenda?.herinneringUrenVooraf ?? 24;

      document.getElementById("mail_name").value = CURRENT.communicatie?.emailAfzenderNaam ?? "";
      document.getElementById("mail_addr").value = CURRENT.communicatie?.emailAfzenderAdres ?? "";
      document.getElementById("wa_groups").checked = !!CURRENT.communicatie?.whatsappAutomatischGroeperen;

      document.getElementById("roles").value = (CURRENT.security?.rollen || []).join(", ");
      // logo live tonen
      const logo = document.getElementById("logo");
      logo.src = CURRENT.org?.logoUrl || "/logo.png";
      if (!CURRENT.org?.logoUrl) logo.style.display = "none"; else logo.style.display = "block";
    }

    async function saveSettings() {
      // lees actuele waarden terug
      CURRENT.org.naam = document.getElementById("org_naam").value.trim();
      CURRENT.org.logoUrl = document.getElementById("org_logoUrl").value.trim();
      CURRENT.org.primaireKleur = document.getElementById("org_kleur").value.trim();

      CURRENT.logic.maxActieveReservatiesPerKlas = parseInt(document.getElementById("logic_maxRes").value || "0", 10);
      CURRENT.logic.annulatieUurgrens = parseInt(document.getElementById("logic_cancelHrs").value || "0", 10);
      CURRENT.logic.creditVerbruik = document.getElementById("logic_credit").value;

      CURRENT.agenda.icsExportAan = document.getElementById("ics_on").checked;
      CURRENT.agenda.persoonlijkeIcsAlleenEigenBoekingen = document.getElementById("ics_only_self").checked;
      CURRENT.agenda.herinneringUrenVooraf = parseInt(document.getElementById("reminder_hrs").value || "0", 10);

      CURRENT.communicatie.emailAfzenderNaam = document.getElementById("mail_name").value.trim();
      CURRENT.communicatie.emailAfzenderAdres = document.getElementById("mail_addr").value.trim();
      CURRENT.communicatie.whatsappAutomatischGroeperen = document.getElementById("wa_groups").checked;

      CURRENT.security.rollen = document.getElementById("roles").value.split(",").map(s => s.trim()).filter(Boolean);

      const saved = await api("PUT", "/api/settings", CURRENT);
      alert("Instellingen bewaard ✅");
      CURRENT =
