<!doctype html><html lang="nl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Doelgroepen – Admin</title>
<style>
body{font-family:system-ui,sans-serif;max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:12px}
label{display:inline-block;margin:6px 8px 6px 0}
select,input,button{padding:8px;border:1px solid #ccc;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
.pill{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;background:#fafafa}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;color:#fff;font-weight:600;background:#1976d2}
.muted{color:#666}
</style>
</head><body>
<h1>🎯 Doelgroepen / Segmenten</h1>
<div class="card">
  <label>Cursus:
    <select id="course">
      <option value="course-001">Puppy</option>
      <option value="course-002">Gevorderden</option>
    </select>
  </label>
  <label>Segment:
    <select id="segment">
      <option value="">(alle segmenten met aantallen)</option>
      <option value="active_member">Actieve leden</option>
      <option value="nearly_expiring">Bijna verlopen</option>
      <option value="completed">Uitgepuurd (0 credits)</option>
      <option value="pending_approval">Wacht op goedkeuring</option>
      <option value="inactive">Inactief</option>
    </select>
  </label>
  <button id="loadBtn">Laden</button>
  <button id="copyBtn" disabled>Kopieer e-mails</button>
  <button id="csvBtn" disabled>Exporteer CSV</button>
  <div id="msg" class="muted"></div>
</div>

<div id="counts" class="card" style="display:none">
  <h3>Overzicht</h3>
  <table><thead><tr><th>Segment</th><th>Aantal</th></tr></thead><tbody id="cntRows"></tbody></table>
</div>

<div id="list" class="card" style="display:none">
  <h3 id="listTitle">Lijst</h3>
  <table>
    <thead><tr><th>Klant</th><th>E-mail</th><th>Hond</th><th>Course</th><th>Credits</th><th>Geldig t/m</th><th>Dagen</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
const $=s=>document.querySelector(s);
const api=(p)=>fetch(p,{credentials:'include'});
function fmtDate(ts){ try{return ts? new Date(ts).toLocaleDateString():'';}catch(e){return '';} }
function toCSV(rows){
  const header = ['customer_name','email','dog_name','course_id','remaining_total','valid_until','days_left'];
  const escape = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const lines = [header.join(',')].concat(rows.map(r=>header.map(k=>escape(r[k])).join(',')));
  return lines.join('\n');
}
async function load(){
  $('#msg').textContent='';
  const course_id=$('#course').value; const seg=$('#segment').value;
  $('#copyBtn').disabled=true; $('#csvBtn').disabled=true;
  const url = '/api/admin/segments?course_id='+encodeURIComponent(course_id)+(seg?('&segment='+seg):'');
  const r=await api(url); const data=await r.json();
  if(!r.ok){ $('#msg').textContent='❌ Fout bij laden'; return; }
  if(!seg){
    $('#counts').style.display='block'; $('#list').style.display='none';
    const rows=$('#cntRows'); rows.innerHTML='';
    const mapping = {active_member:'Actieve leden', nearly_expiring:'Bijna verlopen', completed:'Uitgepuurd', pending_approval:'Wacht op goedkeuring', inactive:'Inactief'};
    Object.entries(data.counts||{}).forEach(([k,v])=>{
      rows.insertAdjacentHTML('beforeend', `<tr><td>${mapping[k]||k}</td><td><span class="badge">${v}</span></td></tr>`);
    });
  }else{
    $('#counts').style.display='none'; $('#list').style.display='block';
    $('#listTitle').textContent = `Segment: ${seg} (${data.count}) – ${course_id}`;
    const rows=$('#rows'); rows.innerHTML='';
    const items=data.items||[];
    items.forEach(x=>{
      rows.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${x.customer_name||''}</td>
          <td>${x.email||''}</td>
          <td>${x.dog_name||''}</td>
          <td>${x.course_id||''}</td>
          <td><span class="pill">${x.remaining_total??''}</span></td>
          <td>${fmtDate(x.valid_until)}</td>
          <td>${x.days_left??''}</td>
        </tr>`);
    });
    $('#copyBtn').disabled = items.length===0;
    $('#csvBtn').disabled  = items.length===0;
    $('#copyBtn').onclick=()=>{
      const emails = Array.from(new Set(items.map(x=>x.email).filter(Boolean)));
      const txt = emails.join(', ');
      navigator.clipboard?.writeText(txt);
      $('#msg').textContent = `📋 ${emails.length} e-mails gekopieerd naar klembord.`;
    };
    $('#csvBtn').onclick=()=>{
      const csv = toCSV(items);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `segments_${course_id}_${seg}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };
  }
}
$('#loadBtn').onclick=load; document.addEventListener('DOMContentLoaded', load);
</script>
</body></html>
